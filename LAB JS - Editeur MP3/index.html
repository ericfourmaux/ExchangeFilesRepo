
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Audio Visualizer & Exporter (Vanilla JS)</title>
  <link rel="stylesheet" href="style.css">
  <!-- MP3 export (facultatif). Si absent, l'export MP3 sera d√©sactiv√©. -->
    <script defer src="https://unpkg.com/lamejs@1.2.0/lame.min.js"></script>
</head>
<body>
  

<header>
    <h1>
      Audio Visualizer & Exporter
      <button id="helpBtn" class="btn-secondary small">‚ùî Aide</button>
    </h1>
    <p>Charge un MP3, visualise la forme d‚Äôonde, s√©lectionne, mute les canaux, et exporte en WAV/MP3.</p>
  </header>

  <section class="file-loader">
    <label class="file-label">
      <span>üéµ Charger un fichier audio (.mp3 recommand√©)</span>
      <input id="fileInput" type="file" accept="audio/*" />
    </label>
    <div id="fileInfo" class="file-info">Aucun fichier charg√©</div>
  </section>

  <section class="canvas-section">
    <!-- Barre d'outils (zoom & grille) ajout√©e, mais compacte -->
    <div class="toolbar">
      <div class="zoom-tools">
        <button id="zoomOutBtn" title="Zoom out (Z)">‚ûñ</button>
        <button id="zoomInBtn" title="Zoom in (A)">‚ûï</button>
        <button id="zoomResetBtn" title="Reset zoom (R)">‚ü≤</button>
        <span class="muted">Molette = d√©filement ¬∑ Alt+Molette = zoom</span>
      </div>
      <div class="grid-tools">
        <label><input type="checkbox" id="showGrid" checked /> Grille</label>
        <label><input type="checkbox" id="snapGrid" /> Snap</label>
        <label>BPM <input id="bpmInput" type="number" min="30" max="300" value="120" /></label>
        <label>Mesure
          <select id="timesig">
            <option value="4/4" selected>4/4</option>
            <option value="3/4">3/4</option>
            <option value="6/8">6/8</option>
          </select>
        </label>
      </div>
    </div>

    <canvas id="waveform" width="1280" height="280"></canvas>

    <div class="timeline">
      <span>D√©but s√©lection: <strong id="selStart">0.000 s</strong></span>
      <span>Fin s√©lection: <strong id="selEnd">0.000 s</strong></span>
      <span>Dur√©e s√©lection: <strong id="selDur">0.000 s</strong></span>
    </div>

    <!-- Analyses (FFT + spectrogramme), discrets sous la forme d'onde -->
    <div class="analysis">
      <div class="analysis-panel">
        <div class="panel-title">Spectre (FFT)</div>
        <canvas id="spectrum" width="640" height="140"></canvas>
      </div>
      <div class="analysis-panel">
        <div class="panel-title">Spectrogramme (live)</div>
        <canvas id="spectrogram" width="640" height="140"></canvas>
      </div>
    </div>
  </section>

  <section class="controls">
    <div class="playback">
      <button id="playBtn" disabled>‚ñ∂Ô∏è Lecture</button>
      <button id="pauseBtn" disabled>‚è∏Ô∏è Pause</button>
      <button id="stopBtn" disabled>‚èπÔ∏è Stop</button>
      <label><input type="checkbox" id="loopSel" /> Boucler la s√©lection (L)</label>
      <button id="clearSelBtn" disabled>Effacer la s√©lection (Suppr)</button>
      <button id="addRegionBtn" class="btn-secondary" disabled>‚ûï Ajouter r√©gion (M)</button>
    </div>

    <div class="channels">
      <h3>Canaux & Mix</h3>
      <label><input type="checkbox" id="muteL" /> Mute canal gauche</label>
      <label><input type="checkbox" id="muteR" /> Mute canal droit</label>
      <div class="slider-row">
        <label>Gain gauche: <input id="gainL" type="range" min="0" max="2" step="0.01" value="1" /></label>
        <label>Gain droit: <input id="gainR" type="range" min="0" max="2" step="0.01" value="1" /></label>
      </div>
      <div class="slider-row">
        <label>R√©duction du centre (voix): 
          <input id="centerReduce" type="range" min="0" max="1" step="0.01" value="0" />
          <span id="centerReduceVal">0%</span>
        </label>
        <small>Astuce ‚Äúkaraok√©‚Äù‚ÄØ: 0% = neutre, 100% = annulation maximum du centre</small>
      </div>
    </div>
  </section>

  <section class="export">
    <h3>Export</h3>
    <div class="export-row">
      <label>Format :
        <select id="formatSelect">
          <option value="wav">WAV (lossless)</option>
          <option value="mp3">MP3 (avec lamejs)</option>
        </select>
      </label>

      <label>Contenu :
        <select id="contentSelect">
          <option value="selection-stereo">S√©lection (st√©r√©o, avec r√©glages)</option>
          <option value="full-stereo" selected>Piste compl√®te (st√©r√©o, avec r√©glages)</option>
          <option value="left-mono">Canal gauche seul (mono)</option>
          <option value="right-mono">Canal droit seul (mono)</option>
        </select>
      </label>

      <label>Bitrate MP3 :
        <select id="mp3Bitrate">
          <option>128</option>
          <option selected>192</option>
          <option>256</option>
          <option>320</option>
        </select> kbps
      </label>
    </div>

    <div class="export-row">
      <label><input type="checkbox" id="normalizeChk" /> Normaliser √†</label>
      <input id="targetDb" type="number" step="0.1" value="-1.0" style="width: 80px;" /> dBFS
      <span class="muted">(pr√©‚Äëgain automatique appliqu√© √† l‚Äôexport)</span>
    </div>

    <div class="export-row">
      <button id="exportBtn" disabled>üíæ Exporter</button>
      <span id="exportStatus"></span>
    </div>
  </section>

  <!-- Nouvelle section "R√©gions" (export batch), discr√®te et apr√®s l'Export -->
  <section class="regions">
    <div class="regions-header">
      <h3>R√©gions</h3>
      <button id="exportRegionsBtn" class="btn-secondary" disabled>üíæ Exporter r√©gions (batch)</button>
    </div>
    <div id="regionsList" class="regions-list empty">Aucune r√©gion. Cr√©e-en une depuis la s√©lection (bouton ‚Äú‚ûï Ajouter r√©gion‚Äù).</div>
  </section>

  <footer>
    <small>
      Astuce : clique-et-glisse sur le canvas pour d√©finir la s√©lection.  
      Limitations : la s√©paration par instrument n‚Äôest pas possible ici ; on agit sur les canaux G/D et la r√©duction du centre.
    </small>
  </footer>

  <!-- Modale d'aide -->
  <div id="helpModal" class="modal hidden" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Aide & Raccourcis</h2>
        <button id="helpClose" class="icon">‚úñ</button>
      </div>
      <div class="modal-body">
        <h3>Chargement & Visualisation</h3>
        <ul>
          <li>Charge un fichier audio (MP3, WAV, etc.).</li>
          <li>Zoom‚ÄØ: Alt+molette, boutons ‚ûï/‚ûñ, <kbd>A</kbd>/<kbd>Z</kbd>. Reset‚ÄØ: <kbd>R</kbd>.</li>
          <li>D√©filement‚ÄØ: molette / trackpad.</li>
        </ul>

        <h3>S√©lection & R√©gions</h3>
        <ul>
          <li>Glisse sur le canvas pour d√©finir une s√©lection.</li>
          <li><kbd>I</kbd> : In au curseur ¬∑ <kbd>O</kbd> : Out au curseur ¬∑ <kbd>L</kbd> : Boucle.</li>
          <li><kbd>M</kbd> : Cr√©er r√©gion depuis la s√©lection ¬∑ Export batch via le bouton ‚ÄúExporter r√©gions‚Äù.</li>
          <li><kbd>Suppr</kbd> : Effacer la s√©lection.</li>
          <li><kbd>‚Üê</kbd>/<kbd>‚Üí</kbd> : Nudge du bord le plus proche (0,05s ; <kbd>Shift</kbd> = 0,5s).</li>
          <li><kbd>,</kbd> / <kbd>.</kbd> : Aligner d√©but/fin sur la grille (si Snap actif).</li>
        </ul>

        <h3>Grille Tempo</h3>
        <ul>
          <li>Active la grille et le snapping (BPM et mesure configurables).</li>
          <li>Les lignes √©paisses marquent les d√©buts de mesure.</li>
        </ul>

        <h3>Lecture & Mix</h3>
        <ul>
          <li><kbd>Espace</kbd> : Lecture/Stop ¬∑ Bouton ‚è∏ : Pause.</li>
          <li>Mute G/D, gains, et ‚ÄúR√©duction centre‚Äù (att√©nue le contenu centr√©).</li>
        </ul>

        <h3>Analyse</h3>
        <ul>
          <li>FFT (spectre) en temps r√©el et spectrogramme live.</li>
        </ul>

        <h3>Export</h3>
        <ul>
          <li>WAV (sans perte) ou MP3 (si <code>lamejs</code> charg√©).</li>
          <li>Normalisation‚ÄØ: vise une cr√™te √† la cible (par ex. -1 dBFS).</li>
          <li>Export de la s√©lection, du morceau complet, ou d‚Äôun seul canal.</li>
        </ul>
      </div>
    </div>
  </div>



  <script src="script.js"></script>
</body>
</html>
